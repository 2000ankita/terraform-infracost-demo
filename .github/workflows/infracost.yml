name: Infracost CI

on:
  push:
    paths:
      - '**.tf'
      - '.github/workflows/**.yml'
  pull_request:
    paths:
      - '**.tf'

env:
  INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
  GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}

jobs:
  infracost:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Setup Infracost
        uses: infracost/actions/setup@v2

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -out=tfplan.binary -var="gcp_credentials=${GOOGLE_CREDENTIALS}"

      - name: Convert plan to JSON
        run: terraform show -json tfplan.binary > tfplan.json

      - name: Infracost Breakdown
        run: |
          infracost breakdown --path tfplan.json \
            --format=json \
            --project-name=infracost-proj \
            --out-file infracost-report/infracost-breakdown.json

      - name: Infracost Diff
        run: |
          infracost diff --path tfplan.json \
            --format=diff \
            --project-name=infracost-proj \
            --out-file=infracost-report/infracost-diff.txt

      - name: Upload cost report to repository
        run: |
          mkdir -p infracost-report
          echo "Commit SHA: $GITHUB_SHA" > infracost-report/meta.txt
        shell: bash

      - name: Commit cost report
        uses: EndBug/add-and-commit@v9
        with:
          add: 'infracost-report'
          message: 'chore: update infracost report'
          default_author: github_actions
          push: true

      - name: Post cost estimate as PR comment
        if: github.event_name == 'pull_request'
        uses: infracost/actions/comment@v3
        with:
          path: tfplan.json
          behavior: update
          format: github-comment
