name: Infracost on Push or PR

on:
  push:
    paths:
      - '**.tf'
      - '.github/workflows/**.yml'
  pull_request:
    paths:
      - '**.tf'

env:
  INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
  GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}

jobs:
  infracost:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Install Infracost CLI
        run: |
        curl -s https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
        echo "$HOME/.infracost/bin" >> $GITHUB_PATH


      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -out=tfplan.binary -var="gcp_credentials=${GOOGLE_CREDENTIALS}"

      - name: Convert plan to JSON
        run: terraform show -json tfplan.binary > tfplan.json

      - name: Run Infracost diff
        run: |
          infracost diff \
            --path tfplan.json \
            --project-name infracost-proj \
            --format json \
            --out-file infracost-output.json

      - name: Save cost report to repo
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore: update Infracost report"
          add: 'infracost-output.json'
          default_author: github_actions

      - name: Post Infracost comment on PR
        if: github.event_name == 'pull_request'
        run: |
          infracost comment github \
            --path infracost-output.json \
            --repo $GITHUB_REPOSITORY \
            --github-token ${{ secrets.GITHUB_TOKEN }} \
            --pull-request ${{ github.event.pull_request.number }} \
            --behavior update
