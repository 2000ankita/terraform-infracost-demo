name: Infracost + Vertex AI Recommendations on Push

on:
  push:
    paths:
      - '**/*.tf'
      - '.github/workflows/**.yml'

env:
  INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
  GOOGLE_CREDENTIALS_JSON: ${{ secrets.GCP_CREDENTIALS_JSON }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_LOCATION: us-central1
  GCP_MODEL_ID: chat-bison

jobs:
  cost-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Install Infracost CLI
        run: |
          curl -s https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
          echo "$HOME/.infracost/bin" >> $GITHUB_PATH

      - name: Write GCP credentials to file
        run: echo '${{ secrets.GCP_CREDENTIALS_JSON }}' > key.json

      - name: Terraform Init & Plan
        run: |
          terraform init
          terraform plan -out=tfplan.binary -var="gcp_credentials=$(cat key.json | base64 | tr -d '\n')"

      - name: Convert Plan to JSON
        run: terraform show -json tfplan.binary > tfplan.json

      - name: Run Infracost diff
        run: |
          infracost diff \
            --path tfplan.json \
            --project-name terraform-infracost-genai \
            --format json \
            --out-file infracost-output.json

      - name: Install gcloud CLI and authenticate
        run: |
          sudo apt-get update && sudo apt-get install -y google-cloud-sdk
          echo '${{ secrets.GCP_CREDENTIALS_JSON }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud config set project ${{ env.GCP_PROJECT_ID }}
          gcloud auth application-default login --quiet < /dev/null || true

      - name: Generate Recommendation using Vertex AI
        run: |
          PROMPT=$(jq -c '.' infracost-output.json)
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $(gcloud auth print-access-token)" \
            -H "Content-Type: application/json" \
            "https://us-central1-aiplatform.googleapis.com/v1/projects/${{ env.GCP_PROJECT_ID }}/locations/${{ env.GCP_LOCATION }}/publishers/google/models/${{ env.GCP_MODEL_ID }}:predict" \
            -d '{
              "instances": [{
                "content": "You are a FinOps AI. Analyze this Infracost report and give cloud cost optimization recommendations:\n'"$PROMPT"'"
              }]
            }')

          echo "$RESPONSE" > genai-response.json
          echo "üîç GenAI Recommendation:"
          jq '.predictions[0].content' genai-response.json

      - name: Upload GenAI Response as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: genai-recommendations
          path: genai-response.json
